<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†</title>
    <style>
        :root { --main-red: #ff5a5f; --bg-gray: #f8f8f8; --annee-color: #ff7f50; --yoki-color: #87CEFA; --common-color: #2a9d8f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif; margin: 0; background: var(--bg-gray); color: #333; overflow-x: hidden; padding-bottom: 70px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; 
            position: sticky; top: 0; z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .month-nav { color: var(--main-red); font-weight: bold; font-size: 1.2rem; }

        /* åº—èˆ—åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ï¼ˆå…±æœ‰ç”»é¢ã®ã¿è¡¨ç¤ºï¼‰ */
        .store-tabs { display: flex; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 52px; z-index: 49; }
        .store-tab { flex: 1; text-align: center; padding: 12px 0; font-weight: bold; color: #aaa; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .store-tab.active-annee { color: var(--annee-color); border-bottom-color: var(--annee-color); }
        .store-tab.active-yoki { color: var(--yoki-color); border-bottom-color: var(--yoki-color); }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…±é€š */
        .calendar-section { background: #fff; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid #eee; }
        .day { 
            min-height: 70px; border-right: 1px solid #eee; border-top: 1px solid #eee; 
            padding: 4px; position: relative; font-size: 0.75rem; text-align: center; 
            cursor: pointer; transition: background 0.1s;
        }
        .day:active { background: #f0f0f0; }
        .day:nth-child(7n) { border-right: none; }
        .day.sun { color: #ff5a5f; } .day.sat { color: #007aff; }
        
        /* ã‚·ãƒ•ãƒˆãƒãƒƒã‚¸ï¼ˆ1æ—¥ã«è¤‡æ•°è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ï¼‰ */
        .shift-badge { display: block; margin-top: 2px; padding: 4px 2px; border-radius: 6px; color: #fff; font-size: 0.7rem; font-weight: bold; line-height: 1.1; }

        /* å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒãƒˆãƒªãƒƒã‚¯ã‚¹è¡¨ï¼‰ */
        .shared-section { background: #fff; margin-bottom: 20px; overflow-x: auto; }
        .shared-table { border-collapse: collapse; width: 100%; min-width: 400px; font-size: 0.8rem; }
        .shared-table th, .shared-table td { border: 1px solid #eee; text-align: center; padding: 6px 2px; vertical-align: middle; }
        .shared-table th { background: #f4f4f4; position: sticky; top: 0; z-index: 10; color: #555; }
        .shared-table .date-col { width: 50px; background: #fafafa; font-weight: bold; position: sticky; left: 0; z-index: 5; }
        .shared-table th.date-col { z-index: 15; }
        .shared-table .sun { color: #ff5a5f; } .shared-table .sat { color: #007aff; }

        /* å…¥åŠ›ãƒ‘ãƒ¬ãƒƒãƒˆ */
        #paletteOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; }
        .palette-content { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px 15px 40px; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s; z-index: 101; max-height: 80vh; overflow-y: auto; }
        .palette-content.show { transform: translateY(0); }
        .palette-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #666; font-weight: bold; font-size: 1.1rem; }
        
        .palette-section-title { font-size: 0.85rem; font-weight: bold; margin: 15px 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stamp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stamp { aspect-ratio: 1; border-radius: 8px; border: none; color: #fff; font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .s-del { background: #fff; color: #333; border: 1px dashed #ccc; font-size: 0.7rem; }
        .close-btn { font-size: 28px; color: #ccc; border: none; background: none; cursor: pointer; }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 200; display: none; }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 50; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; color: #999; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--main-red); }
        .nav-item span { display: block; font-size: 1.2rem; margin-bottom: 2px; }
    </style>
</head>
<body>

<header>
    <div style="color:var(--main-red)">MENU</div>
    <div class="month-nav">2026 Shift</div>
    <div style="font-size:1.5rem; color:var(--main-red)">ï¼‹</div>
</header>

<div id="storeTabs" class="store-tabs" style="display: none;">
    <div id="tab-annee" class="store-tab active-annee" onclick="switchStore('annee')">annee</div>
    <div id="tab-yoki" class="store-tab" onclick="switchStore('yoki.')">yoki.</div>
</div>

<div id="personalView">
    <div id="calendarApp"></div>
</div>

<div id="sharedView" style="display: none;">
    <div id="sharedCalendarApp"></div>
</div>

<div id="loading">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...</div>

<div class="bottom-nav">
    <div id="navPersonal" class="nav-item active" onclick="switchView('personal')">
        <span>ğŸ“…</span> å€‹äºº
    </div>
    <div id="navShared" class="nav-item" onclick="switchView('shared')">
        <span>ğŸ‘¥</span> å…±æœ‰
    </div>
</div>

<div id="paletteOverlay">
    <div id="paletteContent" class="palette-content">
        <div class="palette-header">
            <span id="selectedDateDisplay">æ—¥ä»˜ã‚’é¸æŠ</span>
            <button class="close-btn" onclick="closePalette()">Ã—</button>
        </div>
        
        <div class="palette-section-title" style="color: var(--annee-color);">â–  annee ã‚·ãƒ•ãƒˆ</div>
        <div class="stamp-grid">
            <button class="stamp" style="background:var(--annee-color)" onclick="applyShift('0920', '#ff7f50', 'annee')">09<br>20</button>
            <button class="stamp" style="background:var(--annee-color)" onclick="applyShift('1020', '#ff7f50', 'annee')">10<br>20</button>
            <button class="stamp" style="background:var(--annee-color)" onclick="applyShift('ä¼‘ã¿', '#ff7f50', 'annee')">ä¼‘ã¿</button>
            <button class="stamp s-del" onclick="applyShift('', '', 'annee')">annee<br>æ¶ˆå»</button>
        </div>

        <div class="palette-section-title" style="color: var(--yoki-color);">â–  yoki. ã‚·ãƒ•ãƒˆ</div>
        <div class="stamp-grid">
            <button class="stamp" style="background:var(--yoki-color)" onclick="applyShift('0920', '#87CEFA', 'yoki.')">09<br>20</button>
            <button class="stamp" style="background:var(--yoki-color)" onclick="applyShift('1020', '#87CEFA', 'yoki.')">10<br>20</button>
            <button class="stamp" style="background:var(--yoki-color)" onclick="applyShift('ä¼‘ã¿', '#87CEFA', 'yoki.')">ä¼‘ã¿</button>
            <button class="stamp s-del" onclick="applyShift('', '', 'yoki.')">yoki.<br>æ¶ˆå»</button>
        </div>

        <div class="palette-section-title" style="color: var(--common-color);">â–  å…±é€š</div>
        <div class="stamp-grid" style="grid-template-columns: repeat(4, 1fr);">
            <button class="stamp" style="background:var(--common-color)" onclick="applyShift('ä½œæ¥­æ—¥', '#2a9d8f', 'common')">ä½œæ¥­æ—¥</button>
            <button class="stamp s-del" onclick="applyShift('', '', 'common')">ä½œæ¥­<br>æ¶ˆå»</button>
        </div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz3Cnb2C_o8xjb9I_I_0jfgNXMhmo_TzcLh76MQ8FqYg9lYRx3VdEo4OdNVxpJO2fYl/exec";

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—
    function getUserId() {
        let id = localStorage.getItem('shift_app_user_id');
        if (!id) {
            id = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('shift_app_user_id', id);
        }
        return id;
    }
    const CURRENT_USER_ID = getUserId();
    
    // åº—èˆ—ã®è¨˜æ†¶ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯anneeï¼‰
    let currentStore = localStorage.getItem('shift_app_store') || 'annee';
    let currentView = 'personal';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿
    let globalShiftData = [];
    let globalUsersData = [];

    let activeDayElement = null;
    let activeDateString = "";

    window.onload = function() {
        renderAllPersonalCalendars();
        fetchDataFromGas();
    };

    // --- ç”»é¢ï¼†åº—èˆ— åˆ‡ã‚Šæ›¿ãˆå‡¦ç† ---
    function switchView(viewName) {
        currentView = viewName;
        document.getElementById('personalView').style.display = (viewName === 'personal') ? 'block' : 'none';
        document.getElementById('sharedView').style.display = (viewName === 'shared') ? 'block' : 'none';
        document.getElementById('storeTabs').style.display = (viewName === 'shared') ? 'flex' : 'none';
        
        document.getElementById('navPersonal').className = (viewName === 'personal') ? 'nav-item active' : 'nav-item';
        document.getElementById('navShared').className = (viewName === 'shared') ? 'nav-item active' : 'nav-item';
        
        if (viewName === 'shared') {
            switchStore(currentStore); // ç¾åœ¨ã®åº—èˆ—ã§å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
        }
    }

    function switchStore(storeName) {
        currentStore = storeName;
        localStorage.setItem('shift_app_store', storeName); // è¨˜æ†¶ã™ã‚‹

        // ã‚¿ãƒ–ã®è¦‹ãŸç›®å¤‰æ›´
        document.getElementById('tab-annee').className = 'store-tab' + (storeName === 'annee' ? ' active-annee' : '');
        document.getElementById('tab-yoki').className = 'store-tab' + (storeName === 'yoki.' ? ' active-yoki' : '');

        if (currentView === 'shared') {
            renderSharedCalendars();
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿ã®å–å¾— ---
    function fetchDataFromGas() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        fetch(GAS_URL)
            .then(response => response.json())
            .then(data => {
                // GASã®æ–°ã—ã„å½¢å¼ã«å¯¾å¿œ { shifts: [], users: [] }
                // â€»ä¸‡ãŒä¸€æ—§å½¢å¼ï¼ˆé…åˆ—ï¼‰ã§è¿”ã£ã¦ããŸå ´åˆã®å®‰å…¨å¯¾ç­–å«ã‚€
                const shifts = Array.isArray(data) ? data : (data.shifts || []);
                globalUsersData = data.users || [];

                globalShiftData = shifts.map(item => {
                    if (item.date && item.date.includes('T')) {
                        item.date = item.date.split('T')[0];
                    }
                    return item;
                });
                
                applyDataToPersonalCalendar();
                loading.style.display = 'none';
            })
            .catch(err => {
                console.error("Load Error:", err);
                loading.style.display = 'none';
            });
    }

    // --- å€‹äººã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®ãƒ‡ãƒ¼ã‚¿åæ˜  ---
    function applyDataToPersonalCalendar() {
        document.querySelectorAll('.shift-area').forEach(el => el.innerHTML = '');
        
        // è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã‚’ã™ã¹ã¦æŠ½å‡ºï¼ˆè¤‡æ•°åº—èˆ—ã®æ›ã‘æŒã¡å¯¾å¿œï¼‰
        const myShifts = globalShiftData.filter(item => item.user_id === CURRENT_USER_ID);
        
        myShifts.forEach(shift => {
            const targetDiv = document.querySelector(`.day[data-date="${shift.date}"] .shift-area`);
            if (targetDiv) {
                targetDiv.innerHTML += `<span class="shift-badge" style="background:${shift.color}">${shift.shift_label}</span>`;
            }
        });
    }

    // --- å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆè¡¨ï¼‰ã®æç”» ---
    function renderSharedCalendars() {
        const container = document.getElementById('sharedCalendarApp');
        container.innerHTML = ""; 

        // é¸æŠä¸­ã®åº—èˆ—ã«æ‰€å±ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ã‚’ãƒã‚¹ã‚¿ã‹ã‚‰æŠ½å‡º
        let targetUsers = globalUsersData.filter(u => u.stores && u.stores.includes(currentStore));
        
        // ï¼ˆå®‰å…¨å¯¾ç­–ï¼šã‚‚ã—ãƒã‚¹ã‚¿ãŒç©ºãªã‚‰ã€ã‚·ãƒ•ãƒˆå±¥æ­´ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä»®ç”Ÿæˆï¼‰
        if (targetUsers.length === 0) {
            const tempUsers = {};
            globalShiftData.forEach(item => {
                if (item.store === currentStore) {
                    tempUsers[item.user_id] = item.user_name;
                }
            });
            targetUsers = Object.keys(tempUsers).map(uid => ({ id: uid, name: tempUsers[uid] }));
            
            // ãã‚Œã§ã‚‚èª°ã‚‚ã„ãªã‘ã‚Œã°ã€Œã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€è¡¨ç¤º
            if (targetUsers.length === 0) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">${currentStore} ã®ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }
        }

        const now = new Date();
        for (let i = 0; i < 4; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            createSharedTable(d.getFullYear(), d.getMonth() + 1, targetUsers, container);
        }
    }

    function createSharedTable(year, month, targetUsers, container) {
        const section = document.createElement('div');
        section.className = 'shared-section';

        const title = document.createElement('div');
        title.style.padding = "10px"; title.style.fontWeight = "bold"; title.style.color = "#666"; title.style.borderBottom = "1px solid #eee";
        title.innerText = `${year} / ${month}`;
        section.appendChild(title);

        const table = document.createElement('table');
        table.className = 'shared-table';

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        let headerRow = `<tr><th class="date-col">æ—¥ä»˜</th>`;
        targetUsers.forEach(u => {
            headerRow += `<th>${u.name}</th>`;
        });
        headerRow += `</tr>`;
        table.innerHTML = `<thead>${headerRow}</thead>`;

        const tbody = document.createElement('tbody');
        const daysInMonth = new Date(year, month, 0).getDate();
        const weekChars = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const dayOfWeek = dateObj.getDay();
            const y = dateObj.getFullYear();
            const m = ('0' + (dateObj.getMonth() + 1)).slice(-2);
            const da = ('0' + dateObj.getDate()).slice(-2);
            const isoDate = `${y}-${m}-${da}`;

            const tr = document.createElement('tr');
            let dateClass = "date-col" + (dayOfWeek === 0 ? " sun" : "") + (dayOfWeek === 6 ? " sat" : "");
            tr.innerHTML = `<td class="${dateClass}">${m}/${da} <span style="font-size:0.7em">(${weekChars[dayOfWeek]})</span></td>`;

            targetUsers.forEach(u => {
                // ã“ã®äººãƒ»ã“ã®æ—¥ãƒ»ã“ã®åº—èˆ—ï¼ˆã¾ãŸã¯å…±é€šï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
                const shift = globalShiftData.find(item => item.user_id === u.id && item.date === isoDate && (item.store === currentStore || item.store === 'common'));
                let cellHtml = "<td></td>";
                if (shift) {
                    cellHtml = `<td><span class="shift-badge" style="background:${shift.color}; margin:0 auto; max-width: 40px;">${shift.shift_label}</span></td>`;
                }
                tr.innerHTML += cellHtml;
            });
            tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        section.appendChild(table);
        container.appendChild(section);
    }

    // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ãƒ»ãƒ‘ãƒ¬ãƒƒãƒˆå‡¦ç† ---
    function renderAllPersonalCalendars() {
        const container = document.getElementById('calendarApp');
        container.innerHTML = ""; 
        const now = new Date();
        for (let i = 0; i < 4; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            renderCalendar(d.getFullYear(), d.getMonth() + 1, container);
        }
    }

    function renderCalendar(year, month, container) {
        const section = document.createElement('div'); section.className = 'calendar-section';
        const title = document.createElement('div'); title.style.padding = "10px"; title.style.fontWeight = "bold"; title.style.color = "#666"; title.style.borderBottom = "1px solid #eee"; title.innerText = `${year} / ${month}`;
        section.appendChild(title);
        const grid = document.createElement('div'); grid.className = 'grid';
        const firstDay = new Date(year, month - 1, 1).getDay(); const daysInMonth = new Date(year, month, 0).getDate();
        for (let i = 0; i < firstDay; i++) { grid.appendChild(document.createElement('div')); }
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const isoDate = `${dateObj.getFullYear()}-${('0' + (dateObj.getMonth() + 1)).slice(-2)}-${('0' + dateObj.getDate()).slice(-2)}`;
            const dayOfWeek = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][dateObj.getDay()];
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day' + (dateObj.getDay() === 0 ? ' sun' : '') + (dateObj.getDay() === 6 ? ' sat' : ''); 
            dayDiv.setAttribute('data-date', isoDate);
            dayDiv.innerHTML = `<b>${d}</b><div class="shift-area"></div>`;
            dayDiv.onclick = function() { openPalette(this, `${year} / ${month} / ${d} (${dayOfWeek})`, isoDate); };
            grid.appendChild(dayDiv);
        }
        section.appendChild(grid); container.appendChild(section);
    }

    function openPalette(el, dateText, dateIso) {
        activeDayElement = el; activeDateString = dateIso; 
        document.getElementById('selectedDateDisplay').innerText = dateText;
        const overlay = document.getElementById('paletteOverlay'); const content = document.getElementById('paletteContent');
        overlay.style.display = 'block'; setTimeout(() => content.classList.add('show'), 10);
    }

    function closePalette() {
        const content = document.getElementById('paletteContent'); content.classList.remove('show');
        setTimeout(() => { document.getElementById('paletteOverlay').style.display = 'none'; }, 300);
    }

    function applyShift(label, color, store) {
        if (!activeDayElement) return;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆå‰Šé™¤ or è¿½åŠ /ä¸Šæ›¸ãï¼‰
        const existingIndex = globalShiftData.findIndex(item => item.user_id === CURRENT_USER_ID && item.date === activeDateString && item.store === store);
        
        if (label) {
            const newData = { user_id: CURRENT_USER_ID, user_name: "ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼", date: activeDateString, shift_label: label, color: color, store: store };
            if (existingIndex >= 0) globalShiftData[existingIndex] = newData;
            else globalShiftData.push(newData);
        } else {
            // æ¶ˆå»ã®å ´åˆ
            if (existingIndex >= 0) globalShiftData.splice(existingIndex, 1);
        }

        // å€‹äººã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å†æç”»ï¼ˆã“ã®æ—¥ã®ã¿ï¼‰
        const area = activeDayElement.querySelector('.shift-area');
        area.innerHTML = '';
        const dayShifts = globalShiftData.filter(item => item.user_id === CURRENT_USER_ID && item.date === activeDateString);
        dayShifts.forEach(shift => {
            area.innerHTML += `<span class="shift-badge" style="background:${shift.color}">${shift.shift_label}</span>`;
        });

        // GASã¸é€ä¿¡
        saveDataToGas(activeDateString, label, color, store);
        closePalette();
    }

    function saveDataToGas(date, label, color, store) {
        const data = { user_id: CURRENT_USER_ID, user_name: "ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼", date: date, shift_label: label, color: color, store: store };
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors', headers: { 'Content-Type': 'text/plain' } })
        .then(() => console.log("Saved to GAS")).catch(err => console.error("Save Error:", err));
    }
</script>
</body>
</html>
