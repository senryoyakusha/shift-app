<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Ç∑„Éï„ÉàÁÆ°ÁêÜ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --main-red: #ff5a5f; --bg-gray: #f8f8f8; 
            --annee-g1: #e76f51; --annee-g2: #f4a261; 
            --yoki-g1: #1d3557;  --yoki-g2: #457b9d;  
            --common-color: #2a9d8f; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: var(--bg-gray); color: #333; overflow-x: hidden; padding-bottom: 70px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .month-nav { color: var(--main-red); font-weight: bold; font-size: 1.2rem; }
        .header-icons { display: flex; gap: 15px; font-size: 1.4rem; color: var(--main-red); align-items: center; }
        .icon-btn { cursor: pointer; transition: transform 0.1s; }
        .icon-btn:active { transform: scale(0.8); }

        .store-tabs { display: flex; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 52px; z-index: 49; }
        .store-tab { flex: 1; text-align: center; padding: 12px 0; font-weight: bold; color: #aaa; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; display: none; }
        .store-tab.active-annee { color: var(--annee-g1); border-bottom-color: var(--annee-g1); }
        .store-tab.active-yoki { color: var(--yoki-g1); border-bottom-color: var(--yoki-g1); }

        #calendarApp { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .calendar-section { flex: 0 0 100%; width: 100%; background: #fff; scroll-snap-align: start; box-sizing: border-box; }
        
        #sharedCalendarApp { display: block; }
        .shared-section { width: 100%; background: #fff; box-sizing: border-box; margin-bottom: 20px; }
        
        .month-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
        .month-title { font-weight: bold; color: #666; font-size: 1.1rem; }
        .month-total { font-size: 0.85rem; color: var(--main-red); font-weight: bold; background: #ffeeee; padding: 4px 10px; border-radius: 12px; }

        .grid { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid #eee; }
        
        .day-header { text-align: center; font-size: 0.7rem; font-weight: bold; padding: 6px 0; background: #fff; border-bottom: 1px solid #eee; border-right: 1px solid #eee; color: #666; }
        .day-header:nth-child(7n) { border-right: none; }
        .day-header.sun { color: #ff5a5f; }
        .day-header.sat { color: #007aff; }

        .day { min-height: 70px; border-right: 1px solid #eee; border-top: 1px solid #eee; padding: 4px; position: relative; font-size: 0.75rem; text-align: center; cursor: pointer; transition: background 0.1s; }
        .day:nth-child(7n) { border-right: none; }
        .day.sun { color: #ff5a5f; } 
        .day.sat { color: #007aff; }
        .holiday { color: #ff5a5f !important; }
        .today { background-color: #e6f7ff; }
        .day:active, .day.active-focus { background: #ffebeb !important; }

        .shift-badge { display: block; margin-top: 2px; padding: 4px 2px; border-radius: 4px; color: #fff; font-size: 0.65rem; font-weight: bold; line-height: 1.2; text-align: center; word-break: break-word; }

        .table-wrap { overflow-x: auto; }
        .shared-table { border-collapse: collapse; width: 100%; min-width: 400px; font-size: 0.8rem; }
        .shared-table th, .shared-table td { border: 1px solid #eee; text-align: center; padding: 4px 2px; vertical-align: middle; }
        .shared-table th { background: #f4f4f4; position: sticky; top: 0; z-index: 10; color: #555; }
        .shared-table .date-col { width: 45px; background: #fafafa; font-weight: bold; position: sticky; left: 0; z-index: 5; }
        .shared-table th.date-col { z-index: 15; }
        .shared-table .sun { color: #ff5a5f; } .shared-table .sat { color: #007aff; }
        .row-short { background-color: #ebf5ff !important; }
        .row-over { background-color: #ffebeb !important; }
        .total-row { background-color: #fff9e6 !important; font-weight: bold; color: #d97706; }
        .total-row .date-col { background-color: #fff9e6 !important; color: #d97706; }

        #paletteOverlay { display: none; position: fixed; bottom: 70px; left: 0; width: 100%; height: 38vh; background: #fff; z-index: 100; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-radius: 15px 15px 0 0; }
        .palette-content { height: 100%; padding: 10px 10px 15px; box-sizing: border-box; overflow-y: auto; }
        .palette-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .selected-date { font-weight: bold; color: var(--main-red); font-size: 1rem; }
        
        .palette-section-title { font-size: 0.75rem; font-weight: bold; margin: 10px 0 5px; color: #666; }
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .stamp { padding: 8px 0; border-radius: 6px; border: none; color: #fff; font-weight: bold; font-size: 0.7rem; text-align: center; cursor: pointer; transition: 0.1s; line-height: 1.2; }
        .stamp:active { transform: scale(0.9); }
        .s-del { background: #fff; color: #333; border: 1px dashed #ccc; }
        .close-btn { font-size: 24px; color: #aaa; border: none; background: none; cursor: pointer; padding: 0 5px; }
        
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 200; display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; z-index: 150; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #999; font-size: 0.75rem; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--main-red); }
        .nav-item span { display: block; font-size: 1.4rem; margin-bottom: 2px; }
        body.palette-open { padding-bottom: calc(38vh + 70px); }

        #settingsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 300; }
        .settings-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; width: 90%; max-width: 400px; border-radius: 15px; padding: 25px 20px; box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .settings-header { font-weight: bold; font-size: 1.2rem; color: #333; margin-bottom: 10px; text-align: center; }
        .settings-desc { font-size: 0.8rem; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .settings-radio { margin-bottom: 15px; font-size: 0.85rem; color: #444; }
        .settings-radio label { display: block; margin-bottom: 10px; cursor: pointer; }
        .settings-radio input { margin-right: 5px; transform: scale(1.1); }
        .btn-generate { display: block; width: 100%; padding: 12px; background: var(--main-red); color: #fff; text-align: center; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-generate:active { opacity: 0.8; }
        .url-input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; background: #fff; margin-bottom: 10px; }
        .close-settings { position: absolute; top: 15px; right: 15px; font-size: 24px; color: #bbb; background: none; border: none; cursor: pointer; padding: 0 5px; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold;">
        <img src="logo.png" alt="Logo" style="height: 28px; object-fit: contain; vertical-align: middle;">
    </div>
    <div class="month-nav">2026</div>
    <div class="header-icons">
        <div class="icon-btn" onclick="fetchDataFromGas(true)">üîÑ</div>
        <div class="icon-btn" onclick="openSettings()">‚öôÔ∏è</div>
    </div>
</header>

<div id="storeTabs" class="store-tabs" style="display: none;">
    <div id="tab-annee" class="store-tab" onclick="switchStore('annee')">annee</div>
    <div id="tab-yoki" class="store-tab" onclick="switchStore('yoki.')">yoki.</div>
</div>

<div id="personalView"><div id="calendarApp"></div></div>
<div id="sharedView" style="display: none;"><div id="sharedCalendarApp"></div></div>
<div id="loading">Ë™≠Ëæº‰∏≠...</div>

<div class="bottom-nav">
    <div id="navPersonal" class="nav-item active" onclick="switchView('personal')"><span>üìÖ</span> ÂÄã‰∫∫</div>
    <div id="navShared" class="nav-item" onclick="switchView('shared')"><span>üë•</span> ÂÖ±Êúâ</div>
</div>

<div id="paletteOverlay">
    <div id="paletteContent" class="palette-content">
        <div class="palette-header">
            <span id="selectedDateDisplay" class="selected-date">Êó•‰ªò„ÇíÈÅ∏Êäû</span>
            <button class="close-btn" onclick="closePalette()">√ó</button>
        </div>
        
        <div id="palette-group-annee" style="display:none;">
            <div class="palette-section-title">‚ñ† annee</div>
            <div class="stamp-grid">
                <button class="stamp" style="background:var(--annee-g1)" onclick="applyShift('annee0919', 'var(--annee-g1)', 'annee')">annee<br>0919</button>
                <button class="stamp" style="background:var(--annee-g1)" onclick="applyShift('annee0920', 'var(--annee-g1)', 'annee')">annee<br>0920</button>
                <button class="stamp" style="background:var(--annee-g1)" onclick="applyShift('annee0921', 'var(--annee-g1)', 'annee')">annee<br>0921</button>
                <button class="stamp" style="background:var(--annee-g1)" onclick="applyShift('annee1019', 'var(--annee-g1)', 'annee')">annee<br>1019</button>
                <button class="stamp" style="background:var(--annee-g1)" onclick="applyShift('annee1020', 'var(--annee-g1)', 'annee')">annee<br>1020</button>
                
                <button class="stamp" style="background:var(--annee-g2)" onclick="applyShift('annee0916', 'var(--annee-g2)', 'annee')">annee<br>0916</button>
                <button class="stamp" style="background:var(--annee-g2)" onclick="applyShift('annee0917', 'var(--annee-g2)', 'annee')">annee<br>0917</button>
                <button class="stamp" style="background:var(--annee-g2)" onclick="applyShift('annee1116', 'var(--annee-g2)', 'annee')">annee<br>1116</button>
                <button class="stamp" style="background:var(--annee-g2)" onclick="applyShift('annee1621', 'var(--annee-g2)', 'annee')">annee<br>1621</button>
                <button class="stamp" style="background:var(--annee-g2)" onclick="applyShift('annee1721', 'var(--annee-g2)', 'annee')">annee<br>1721</button>
            </div>
        </div>

        <div id="palette-group-yoki" style="display:none;">
            <div class="palette-section-title">‚ñ† yoki.</div>
            <div class="stamp-grid">
                <button class="stamp" style="background:var(--yoki-g1)" onclick="applyShift('yoki.0919', 'var(--yoki-g1)', 'yoki.')">yoki.<br>0919</button>
                <button class="stamp" style="background:var(--yoki-g1)" onclick="applyShift('yoki.0920', 'var(--yoki-g1)', 'yoki.')">yoki.<br>0920</button>
                <button class="stamp" style="background:var(--yoki-g1)" onclick="applyShift('yoki.0921', 'var(--yoki-g1)', 'yoki.')">yoki.<br>0921</button>
                <button class="stamp" style="background:var(--yoki-g1)" onclick="applyShift('yoki.1019', 'var(--yoki-g1)', 'yoki.')">yoki.<br>1019</button>
                <button class="stamp" style="background:var(--yoki-g1)" onclick="applyShift('yoki.1020', 'var(--yoki-g1)', 'yoki.')">yoki.<br>1020</button>
                
                <button class="stamp" style="background:var(--yoki-g2)" onclick="applyShift('yoki.0916', 'var(--yoki-g2)', 'yoki.')">yoki.<br>0916</button>
                <button class="stamp" style="background:var(--yoki-g2)" onclick="applyShift('yoki.0917', 'var(--yoki-g2)', 'yoki.')">yoki.<br>0917</button>
                <button class="stamp" style="background:var(--yoki-g2)" onclick="applyShift('yoki.1116', 'var(--yoki-g2)', 'yoki.')">yoki.<br>1116</button>
                <button class="stamp" style="background:var(--yoki-g2)" onclick="applyShift('yoki.1621', 'var(--yoki-g2)', 'yoki.')">yoki.<br>1621</button>
                <button class="stamp" style="background:var(--yoki-g2)" onclick="applyShift('yoki.1721', 'var(--yoki-g2)', 'yoki.')">yoki.<br>1721</button>
            </div>
        </div>

        <div class="palette-section-title">‚ñ† ÂÖ±ÈÄö</div>
        <div class="stamp-grid" style="grid-template-columns: repeat(4, 1fr);">
            <button class="stamp" style="background:#ff5e99" onclick="applyShift('‰ºë„Åø', '#ff5e99', 'common')">‰ºë„Åø</button>
            <button class="stamp" style="background:#e63946" onclick="applyShift('Â∏åÊúõ‰ºë', '#e63946', 'common')">Â∏åÊúõ‰ºë</button>
            <button class="stamp" style="background:var(--common-color)" onclick="applyShift('‰ΩúÊ•≠Êó•', '#2a9d8f', 'common')">‰ΩúÊ•≠Êó•</button>
            <button class="stamp s-del" onclick="applyShift('', '', '')">Ê∂àÂéª</button>
        </div>
    </div>
</div>

<div id="settingsOverlay">
    <div class="settings-content">
        <button class="close-settings" onclick="closeSettings()">√ó</button>
        <div class="settings-header">üìÖ Google„Ç´„É¨„É≥„ÉÄ„ÉºÈÄ£Êê∫</div>
        <div class="settings-desc">
            „Åì„Åì„Å´Ëá™ÂàÜ„ÅÆGmail„Ç¢„Éâ„É¨„Çπ„ÇíÁôªÈå≤„Åó„Å¶„Åä„Åè„Å®„ÄÅ„Ç∑„Éï„Éà„ÇíÂÖ•Âäõ„Åó„ÅüÁû¨Èñì„Å´Ëá™Âãï„Åß„Ç´„É¨„É≥„ÉÄ„Éº„Å´‰∫àÂÆö„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ
        </div>
        <input type="email" id="gmailInput" class="url-input" placeholder="‰æã: you@gmail.com">
        <div class="settings-radio">
            <label><input type="radio" name="sync_mode" value="all" id="syncAll"> „Åô„Åπ„Å¶„ÅÆ„Ç∑„Éï„Éà„ÇíÈÄ£Êê∫„Åô„Çã</label>
            <label><input type="radio" name="sync_mode" value="common" id="syncCommon"> ‰ºë„Åø„Éª‰ΩúÊ•≠Êó•„Å™„Å©ÂÖ±ÈÄö„ÅÆ„ÅøÈÄ£Êê∫</label>
        </div>
        <button class="btn-generate" onclick="saveGmail()">ÈÄ£Êê∫„Çí‰øùÂ≠ò„Åô„Çã</button>
    </div>
</div>

<script>
    const LIFF_ID = "2009130838-xQhedkHz";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz3Cnb2C_o8xjb9I_I_0jfgNXMhmo_TzcLh76MQ8FqYg9lYRx3VdEo4OdNVxpJO2fYl/exec";

    let CURRENT_USER_ID = "";
    let currentUserObj = { id: "", name: "„ÅÇ„Å™„Åü", stores: ['annee', 'yoki.'], is_boss: true, is_core: true };

    let currentStore = localStorage.getItem('shift_app_store') || 'annee';
    let currentView = 'personal';
    
    let globalShiftData = JSON.parse(localStorage.getItem('cached_shifts')) || [];
    let globalUsersData = JSON.parse(localStorage.getItem('cached_users')) || [];
    let syncMode = localStorage.getItem('shift_app_sync_mode') || 'all';
    
    let activeDayElement = null;
    let activeDateString = "";
    let globalHolidays = {};
    let saveQueue = [];
    let isSaving = false;

    // ‚òÖ ‚ë£Á´ã„Å°‰∏ä„ÅíÈÄüÂ∫¶„ÅÆ‰øÆÊ≠£Ôºö„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊû†„ÇíÂÖà„Å´‰Ωú„Å£„Å¶„Åã„Çâ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊµÅ„ÅóËæº„ÇÄÔºÅ
    window.onload = function() {
        fetchHolidays();
        renderAllPersonalCalendars(); // ÂÖà„Å´Êû†„Çí‰Ωú„Çã
        
        if(globalShiftData.length > 0 && globalUsersData.length > 0) {
            applyPermissions();
            applyDataToPersonalCalendar(); // „Åù„ÅÆÂæå„Å´ÊµÅ„ÅóËæº„ÇÄÔºÅ
        }
        initializeLiff();
    };

    function fetchHolidays() {
        fetch('https://holidays-jp.github.io/api/v1/date.json')
            .then(res => res.json())
            .then(data => {
                globalHolidays = data;
                renderAllPersonalCalendars();
                if (currentView === 'shared') renderSharedCalendars();
            })
            .catch(err => console.error("Á•ùÊó•„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", err));
    }

    function initializeLiff() {
        if(globalShiftData.length === 0) document.getElementById('loading').style.display = 'block';
        liff.init({ liffId: LIFF_ID })
            .then(() => {
                if (liff.isLoggedIn()) { return liff.getProfile(); } 
                else { return null; }
            })
            .then(profile => {
                if (profile) {
                    CURRENT_USER_ID = profile.userId;
                    currentUserObj.id = profile.userId;
                    currentUserObj.name = profile.displayName;
                } else {
                    CURRENT_USER_ID = getFallbackUserId();
                    currentUserObj.id = CURRENT_USER_ID;
                }
                fetchDataFromGas();
            })
            .catch(err => {
                console.error("LIFF„Ç®„É©„Éº:", err);
                CURRENT_USER_ID = getFallbackUserId();
                currentUserObj.id = CURRENT_USER_ID;
                fetchDataFromGas();
            });
    }

    function getFallbackUserId() {
        let id = localStorage.getItem('shift_app_user_id');
        if (!id) { id = 'user_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('shift_app_user_id', id); }
        return id;
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible' && CURRENT_USER_ID !== "") {
            fetchDataFromGas(); 
        }
    });

    function applyPermissions() {
        const found = globalUsersData.find(u => u.id === CURRENT_USER_ID);
        if (found) currentUserObj = found;
        
        const isSpecial = currentUserObj.is_boss || currentUserObj.is_core;
        const canSeeAnnee = isSpecial || currentUserObj.stores.includes('annee');
        const canSeeYoki = isSpecial || currentUserObj.stores.includes('yoki.');
        
        document.getElementById('tab-annee').style.display = canSeeAnnee ? 'block' : 'none';
        document.getElementById('tab-yoki').style.display = canSeeYoki ? 'block' : 'none';

        if (currentStore === 'annee' && !canSeeAnnee && canSeeYoki) currentStore = 'yoki.';
        if (currentStore === 'yoki.' && !canSeeYoki && canSeeAnnee) currentStore = 'annee';
        switchStore(currentStore);
    }

    function switchView(viewName) {
        currentView = viewName;
        document.getElementById('personalView').style.display = (viewName === 'personal') ? 'block' : 'none';
        document.getElementById('sharedView').style.display = (viewName === 'shared') ? 'block' : 'none';
        if (viewName === 'shared' && (document.getElementById('tab-annee').style.display === 'block' || document.getElementById('tab-yoki').style.display === 'block')) {
            document.getElementById('storeTabs').style.display = 'flex';
        } else {
            document.getElementById('storeTabs').style.display = 'none';
        }
        document.getElementById('navPersonal').className = (viewName === 'personal') ? 'nav-item active' : 'nav-item';
        document.getElementById('navShared').className = (viewName === 'shared') ? 'nav-item active' : 'nav-item';
        closePalette(); 
        if (viewName === 'shared') switchStore(currentStore);
    }

    function switchStore(storeName) {
        currentStore = storeName;
        localStorage.setItem('shift_app_store', storeName);
        document.getElementById('tab-annee').className = 'store-tab' + (storeName === 'annee' ? ' active-annee' : '');
        document.getElementById('tab-yoki').className = 'store-tab' + (storeName === 'yoki.' ? ' active-yoki' : '');
        if (currentView === 'shared') renderSharedCalendars();
    }

    function fetchDataFromGas(forceUpdate = false) {
        // ‚òÖ ‚ë¢„ÅÆ‰øÆÊ≠£Ôºö„Éá„Éº„Çø„ÇíÈÄÅ‰ø°‰∏≠ÔºàÈ†ÜÁï™ÂæÖ„Å°‰∏≠Ôºâ„ÅØ„ÄÅÂè§„ÅÑ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åæ„Å™„ÅÑ„Çà„ÅÜ„Å´„Éñ„É≠„ÉÉ„ÇØÔºÅ
        if (isSaving && !forceUpdate) return;

        const loading = document.getElementById('loading');
        if(globalShiftData.length === 0 || forceUpdate) loading.style.display = 'block'; 

        fetch(GAS_URL)
            .then(response => response.json())
            .then(data => {
                const shifts = Array.isArray(data) ? data : (data.shifts || []);
                globalUsersData = data.users || [];
                globalShiftData = shifts.map(item => {
                    if (item.date && item.date.includes('T')) item.date = item.date.split('T')[0];
                    return item;
                });
                
                localStorage.setItem('cached_shifts', JSON.stringify(globalShiftData));
                localStorage.setItem('cached_users', JSON.stringify(globalUsersData));
                
                applyPermissions(); 
                applyDataToPersonalCalendar();
                if (currentView === 'shared') renderSharedCalendars();
                loading.style.display = 'none';
            })
            .catch(err => { console.error(err); loading.style.display = 'none'; });
    }

    function calcShiftData(label) {
        let match = label.match(/(\d{2})(\d{2})/);
        if (match) {
            let start = parseInt(match[1], 10);
            let end = parseInt(match[2], 10);
            return end - start;
        }
        return 0;
    }

    function applyDataToPersonalCalendar() {
        document.querySelectorAll('.shift-area').forEach(el => el.innerHTML = '');
        const myShifts = globalShiftData.filter(item => item.user_id === CURRENT_USER_ID);
        const monthlyHours = {};

        myShifts.forEach(shift => {
            const targetDiv = document.querySelector(`.day[data-date="${shift.date}"] .shift-area`);
            if (targetDiv) {
                let displayLabel = shift.shift_label;
                displayLabel = displayLabel.replace(/^(annee|yoki\.)(\d{4})$/, "$1<br>$2");
                targetDiv.innerHTML = `<span class="shift-badge" style="background:${shift.color}">${displayLabel}</span>`;
            }
            const monthKey = shift.date.substring(0, 7);
            const hours = Number(shift.work_hours) || calcShiftData(shift.shift_label);
            monthlyHours[monthKey] = (monthlyHours[monthKey] || 0) + hours;
        });

        for (let key in monthlyHours) {
            const totalSpan = document.getElementById(`total-${key}`);
            if (totalSpan) totalSpan.innerText = `ÂêàË®à: ${monthlyHours[key]}ÊôÇÈñì`;
        }
    }

    function renderSharedCalendars() {
        const container = document.getElementById('sharedCalendarApp');
        container.innerHTML = ""; 
        let targetUsers = globalUsersData.filter(u => u.stores && u.stores.includes(currentStore));
        if (targetUsers.length === 0) return;

        const now = new Date();
        for (let i = 0; i < 5; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            createSharedTable(d.getFullYear(), d.getMonth() + 1, targetUsers, container);
        }
    }

    function createSharedTable(year, month, targetUsers, container) {
        const section = document.createElement('div'); section.className = 'shared-section';
        const title = document.createElement('div'); title.className = 'month-header';
        title.innerHTML = `<span class="month-title">${year} / ${month}</span>`;
        section.appendChild(title);
        
        const tableWrap = document.createElement('div'); tableWrap.className = 'table-wrap';
        const table = document.createElement('table'); table.className = 'shared-table';
        
        let headerRow = `<tr><th class="date-col">Êó•‰ªò</th>`;
        targetUsers.forEach(u => { headerRow += `<th>${u.name}</th>`; });
        headerRow += `</tr>`; table.innerHTML = `<thead>${headerRow}</thead>`;

        const tbody = document.createElement('tbody');
        const daysInMonth = new Date(year, month, 0).getDate();
        const weekChars = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];
        const monthPrefix = `${year}-${('0' + month).slice(-2)}`;

        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const dayOfWeek = dateObj.getDay();
            const y = dateObj.getFullYear(); const m = ('0' + (dateObj.getMonth() + 1)).slice(-2); const da = ('0' + dateObj.getDate()).slice(-2);
            const isoDate = `${y}-${m}-${da}`;
            const tr = document.createElement('tr');
            
            let rowHtml = ""; 
            let hourlyCounts = new Array(24).fill(0);

            targetUsers.forEach(u => {
                const shift = globalShiftData.find(item => item.user_id === u.id && item.date === isoDate && (item.store === currentStore || item.store === 'common'));
                let cellHtml = "<td></td>";
                if (shift) {
                    cellHtml = `<td><span class="shift-badge" style="background:${shift.color}; max-width: 45px; margin:0 auto; font-size:0.6rem;">${shift.shift_label.replace('annee','').replace('yoki.','')}</span></td>`;
                    
                    if (shift.store !== 'common') {
                        let match = shift.shift_label.match(/(\d{2})(\d{2})/);
                        if (match) {
                            let start = parseInt(match[1], 10);
                            let end = parseInt(match[2], 10);
                            for (let h = start; h < end; h++) {
                                if (h >= 0 && h < 24) hourlyCounts[h]++;
                            }
                        }
                    }
                }
                rowHtml += cellHtml;
            });

            let maxCount = Math.max(...hourlyCounts);
            let rowClass = "";
            if (maxCount >= 5) { rowClass = "row-over"; } 
            else if (maxCount <= 3) { rowClass = "row-short"; }

            let dateClass = "date-col" + (dayOfWeek === 0 ? " sun" : "") + (dayOfWeek === 6 ? " sat" : "");
            if (globalHolidays[isoDate]) {
                dateClass += " holiday";
            }

            tr.className = rowClass;
            tr.innerHTML = `<td class="${dateClass} ${rowClass}">${m}/${da} <span style="font-size:0.7em">(${weekChars[dayOfWeek]})</span></td>` + rowHtml;
            tbody.appendChild(tr);
        }
        
        const trTotal = document.createElement('tr'); trTotal.className = 'total-row';
        let totalHtml = `<td class="date-col">ÂêàË®à</td>`;
        targetUsers.forEach(u => {
            let userTotalHrs = 0;
            globalShiftData.forEach(shift => {
                if (shift.user_id === u.id && (shift.store === currentStore || shift.store === 'common') && shift.date.startsWith(monthPrefix)) {
                    let h = Number(shift.work_hours);
                    if (isNaN(h)) h = calcShiftData(shift.shift_label);
                    userTotalHrs += h;
                }
            });
            totalHtml += `<td>${userTotalHrs}h</td>`;
        });
        
        trTotal.innerHTML = totalHtml; tbody.appendChild(trTotal);
        table.appendChild(tbody); tableWrap.appendChild(table); section.appendChild(tableWrap); container.appendChild(section);
    }

    function renderAllPersonalCalendars() {
        const container = document.getElementById('calendarApp');
        container.innerHTML = ""; 
        const now = new Date();
        for (let i = 0; i < 5; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            renderCalendar(d.getFullYear(), d.getMonth() + 1, container);
        }
    }

    function renderCalendar(year, month, container) {
        const section = document.createElement('div'); section.className = 'calendar-section';
        const monthKey = `${year}-${('0' + month).slice(-2)}`;
        
        const title = document.createElement('div'); title.className = 'month-header';
        title.innerHTML = `<span class="month-title">${year} / ${month}</span><span class="month-total" id="total-${monthKey}">ÂêàË®à: 0ÊôÇÈñì</span>`;
        section.appendChild(title);
        
        const grid = document.createElement('div'); grid.className = 'grid';
        const weekChars = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];
        
        weekChars.forEach((w, idx) => {
            const dHeader = document.createElement('div');
            dHeader.className = 'day-header' + (idx === 0 ? ' sun' : (idx === 6 ? ' sat' : ''));
            dHeader.innerText = w;
            grid.appendChild(dHeader);
        });

        const todayObj = new Date();
        const todayIso = `${todayObj.getFullYear()}-${('0' + (todayObj.getMonth() + 1)).slice(-2)}-${('0' + todayObj.getDate()).slice(-2)}`;

        const firstDay = new Date(year, month - 1, 1).getDay(); const daysInMonth = new Date(year, month, 0).getDate();
        for (let i = 0; i < firstDay; i++) { grid.appendChild(document.createElement('div')); }
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month - 1, d);
            const isoDate = `${dateObj.getFullYear()}-${('0' + (dateObj.getMonth() + 1)).slice(-2)}-${('0' + dateObj.getDate()).slice(-2)}`;
            const dayOfWeek = weekChars[dateObj.getDay()];
            
            const dayDiv = document.createElement('div');
            
            let dClass = 'day' + (dateObj.getDay() === 0 ? ' sun' : '') + (dateObj.getDay() === 6 ? ' sat' : ''); 
            if (globalHolidays[isoDate]) { dClass += ' holiday'; }
            if (isoDate === todayIso) { dClass += ' today'; }

            dayDiv.className = dClass;
            dayDiv.setAttribute('data-date', isoDate);
            dayDiv.innerHTML = `<b>${d}</b><div class="shift-area"></div>`;
            dayDiv.onclick = function() { openPalette(this, `${year} / ${month} / ${d} (${dayOfWeek})`, isoDate); };
            grid.appendChild(dayDiv);
        }
        section.appendChild(grid); container.appendChild(section);
    }

    function openPalette(el, dateText, dateIso) {
        if(activeDayElement) activeDayElement.classList.remove('active-focus');
        activeDayElement = el; activeDateString = dateIso; 
        activeDayElement.classList.add('active-focus');
        document.getElementById('selectedDateDisplay').innerText = dateText;
        
        document.getElementById('palette-group-annee').style.display = currentUserObj.stores.includes('annee') ? 'block' : 'none';
        document.getElementById('palette-group-yoki').style.display = currentUserObj.stores.includes('yoki.') ? 'block' : 'none';

        document.getElementById('paletteOverlay').style.display = 'block';
        document.body.classList.add('palette-open'); 
        
        setTimeout(() => {
            const rect = el.getBoundingClientRect();
            if(rect.bottom > window.innerHeight - (window.innerHeight * 0.38)) {
                window.scrollBy({ top: rect.bottom - (window.innerHeight - (window.innerHeight * 0.4)), behavior: 'smooth' });
            }
        }, 10);
    }

    function closePalette() {
        if(activeDayElement) activeDayElement.classList.remove('active-focus');
        document.getElementById('paletteOverlay').style.display = 'none';
        document.body.classList.remove('palette-open');
    }

    function applyShift(label, color, store) {
        if (!activeDayElement) return;
        
        globalShiftData = globalShiftData.filter(item => !(item.user_id === CURRENT_USER_ID && item.date === activeDateString));
        if (label) {
            let h = calcShiftData(label);
            let s = (h >= 9) ? 1 : (h > 0 ? 0.5 : 0);
            globalShiftData.push({ user_id: CURRENT_USER_ID, user_name: currentUserObj.name, date: activeDateString, shift_label: label, color: color, store: store, work_hours: h, attendance_score: s });
        }
        
        // ‚òÖ ‚ë¢„ÅÆ‰øÆÊ≠£ÔºöÊäº„Åó„ÅüÁû¨Èñì„Å´„Çπ„Éû„Éõ„ÅÆË®òÊÜ∂Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ„Çí‰∏äÊõ∏„Åç„Åô„ÇãÔºÅ„Åì„Çå„ÅßÊ∂à„Åà„Å™„ÅÑÔºÅ
        localStorage.setItem('cached_shifts', JSON.stringify(globalShiftData));

        applyDataToPersonalCalendar(); 
        saveDataToGas(activeDateString, label, color, store);

        let nextDateObj = new Date(activeDateString);
        nextDateObj.setDate(nextDateObj.getDate() + 1);
        const nextIso = `${nextDateObj.getFullYear()}-${('0' + (nextDateObj.getMonth() + 1)).slice(-2)}-${('0' + nextDateObj.getDate()).slice(-2)}`;
        const nextDayEl = document.querySelector(`.day[data-date="${nextIso}"]`);

        if (nextDayEl) {
            const dayOfWeek = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"][nextDateObj.getDay()];
            const y = nextDateObj.getFullYear(); const m = nextDateObj.getMonth() + 1; const d = nextDateObj.getDate();
            nextDayEl.closest('.calendar-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            openPalette(nextDayEl, `${y} / ${m} / ${d} (${dayOfWeek})`, nextIso);
        } else {
            closePalette();
        }
    }

    function saveDataToGas(date, label, color, store) {
        const savedEmail = localStorage.getItem('shift_app_gmail') || "";
        const data = { 
            user_id: CURRENT_USER_ID, 
            user_name: currentUserObj.name, 
            date: date, 
            shift_label: label, 
            color: color, 
            store: store,
            google_email: savedEmail,
            sync_mode: syncMode // ‚òÖ ‚ë†„ÅÆ‰øÆÊ≠£ÔºöÈÄ£Êê∫„É¢„Éº„Éâ„ÇÇ‰∏ÄÁ∑í„Å´Ë£èÂÅ¥„Å∏ÈÄÅ„Çã
        };
        saveQueue.push(data);
        processQueue(); 
    }

    function processQueue() {
        if (isSaving || saveQueue.length === 0) return; 
        
        isSaving = true; 
        const data = saveQueue.shift(); 
        
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors', headers: { 'Content-Type': 'text/plain' } })
        .then(() => {
            console.log("Saved to GAS");
            isSaving = false; 
            processQueue(); 
        })
        .catch(err => {
            console.error("Save Error:", err);
            isSaving = false; 
            processQueue(); 
        });
    }

    function openSettings() {
        document.getElementById('gmailInput').value = localStorage.getItem('shift_app_gmail') || "";
        if (syncMode === 'common') {
            document.getElementById('syncCommon').checked = true;
        } else {
            document.getElementById('syncAll').checked = true;
        }
        document.getElementById('settingsOverlay').style.display = 'block';
    }

    function closeSettings() {
        document.getElementById('settingsOverlay').style.display = 'none';
    }

    function saveGmail() {
        const email = document.getElementById('gmailInput').value.trim();
        const mode = document.getElementById('syncCommon').checked ? 'common' : 'all';
        localStorage.setItem('shift_app_gmail', email);
        localStorage.setItem('shift_app_sync_mode', mode);
        syncMode = mode;
        alert('ÈÄ£Êê∫Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        closeSettings();
    }
</script>
</body>
</html>
